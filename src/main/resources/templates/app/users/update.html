<!DOCTYPE html>
<body lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<div layout:fragment="content" class="main-content">
    <div class="row gy-5">
        <hr>
        <div class="col d-flex justify-content-center">
            <h2>회원 정보 수정</h2>
        </div>
        <hr>
        <div class="col-lg-6">
            <div class="row justify-content-start">
                <form th:object="${member}">
                    <input type="hidden" th:name="_csrf" th:value="${_csrf.token}"/>
                    <input type="hidden" th:id="userId" th:value="*{id}">
                    <h3>아이디</h3>
                    <div class="input-group input-group-static mb-4">
                        <label style="font-weight: bold" th:for="username">아이디</label>
                        <input type="text" th:field="*{username}" th:value="*{username}" class="form-control"
                               th:id="username" readonly>
                    </div>
                    <h3>이메일</h3>
                    <div class="input-group input-group-static mb-4">
                        <label style="font-weight: bold" th:for="email">아이디</label>
                        <input type="text" th:field="*{email}" th:value="*{email}" class="form-control"
                               th:id="email" readonly>
                    </div>
                    <h3>자기소개 변경</h3>
                    <div class="input-group input-group-static mb-4">
                        <label style="font-weight: bold" th:for="text">기존 자기소개</label>
                        <input type="text" th:field="*{selfIntroduction}" th:value="*{selfIntroduction}"
                               class="form-control"
                               th:id="selfIntroduction">
                    </div>
                    <h3>비밀번호 변경</h3>
                    <div class="input-group input-group-static mb-4">
                        <label style="font-weight: bold" th:for="password">변경할 비밀번호 입력</label>
                        <input type="password" th:id="password" th:name="password"
                               placeholder="변경할 비밀번호를 입력하세요." class="form-control">
                    </div>
                </form>
                <button id="memberUpdate" class="btn btn-info" value="회원 정보 수정"
                        th:onclick="memberUpdate()">회원 정보 수정
                </button>
                <form id="member-delete-form" th:object="${member}" th:method="delete">
                    <a id="memberDelete" class="btn btn-danger"
                       th:onclick="memberDelete()">회원 탈퇴</a>
                </form>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="scripts">
    <script>
        function memberDelete() {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            const data = {
                id: $('#id').val()
            };
            const confirmCheck = confirm("정말 회원탈퇴 하시겠습니까?");

            if (confirmCheck == true) {
                $.ajax({
                    url: "/member/delete",
                    type: "POST",
                    dataType: "json",
                    data: JSON.stringify(data),
                    beforeSend: function (xhr) {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
                        xhr.setRequestHeader(header, token);
                    }
                }).done(function (result) {
                    console.log(result);
                    if (result) {
                        alert("회원 탈퇴가 완료되었습니다.");
                        window.location.href = "/";
                    } else {
                        $('#password').focus();
                    }
                }).fail(function (error) {
                    alert(JSON.stringify(error));
                });

            }

            function memberUpdate() {
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");
                const data = {
                    id: $('#userId').val(),
                    selfIntroduction: $('#selfIntroduction').val(),
                    password: $('#password').val()
                };

                // 공백 및 빈 문자열 체크
                if (!data.password || data.password.trim() === "") {
                    alert("공백 또는 입력하지 않은 부분이 있습니다.");
                    return false;
                }

                const confirmCheck = confirm("수정하시겠습니까?");

                if (confirmCheck == true) {
                    $.ajax({
                        headers: {
                            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                        },
                        type: 'PUT',
                        url: '/member',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(data),
                        beforeSend: function (xhr) {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
                            xhr.setRequestHeader(header, token);
                        }
                    }).done(function (result) {
                        console.log(result);
                        if (result) {
                            alert("회원 탈퇴가 완료되었습니다.");
                            window.location.href = "/";
                        } else {
                            alert("회원 탈퇴 중 오류가 발생했습니다.")
                            $('#password').focus();
                        }
                    }).fail(function (error) {
                        alert(JSON.stringify(error));
                    });
                }
            }
        }
    </script>
</th:block>
</body>